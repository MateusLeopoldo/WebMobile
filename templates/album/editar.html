{% extends "base.html" %}
{% load static %}

{% block titulo %}Editar Álbum{% endblock %}

{% block extra_head %}
<link href="{% static 'css/formularios.css' %}" rel="stylesheet">
{% endblock %}

{% block conteudo %}
<div class="container py-5">
    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="row justify-content-center">
            <!-- Coluna Principal do Formulário -->
            <div class="col-lg-10">
                <div class="card card-album shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">Editar Álbum: {{ album.titulo }}</h2>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- Seção de Upload da Foto -->
                            <div class="col-md-4 text-center">
                                <label for="{{ form.foto.id_for_label }}" class="form-label fw-bold">Capa do Álbum</label>
                                <div class="mb-2 preview-container">
                                    <img id="preview-foto" src="{% if album.foto %}{{ album.foto.url }}{% else %}{% static 'img/5384366.png' %}{% endif %}"
                                        alt="Pré-visualização da capa" class="img-fluid rounded shadow-sm"
                                        style="max-height: 250px; object-fit: cover;">
                                </div>
                                {{ form.foto }}
                                {% if form.foto.errors %}<div class="text-danger small mt-1">{{ form.foto.errors|striptags }}</div>{% endif %}
                            </div>

                            <!-- Campos do Formulário -->
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-12">
                                        {{ form.titulo.label_tag }}
                                        {{ form.titulo }}
                                        {% if form.titulo.errors %}<div class="text-danger small mt-1">{{ form.titulo.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-12">
                                        {{ form.artista.label_tag }}
                                        {{ form.artista }}
                                        {% if form.artista.errors %}<div class="text-danger small mt-1">{{ form.artista.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-sm-6">
                                        {{ form.genero.label_tag }}
                                        {{ form.genero }}
                                        {% if form.genero.errors %}<div class="text-danger small mt-1">{{ form.genero.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-sm-6">
                                        {{ form.ano_lancamento.label_tag }}
                                        {{ form.ano_lancamento }}
                                        {% if form.ano_lancamento.errors %}<div class="text-danger small mt-1">{{ form.ano_lancamento.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-sm-6">
                                        {{ form.preco.label_tag }}
                                        {{ form.preco }}
                                        {% if form.preco.errors %}<div class="text-danger small mt-1">{{ form.preco.errors|striptags }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção de Músicas -->
                        <hr class="my-4">
                        <h3 class="h5 mb-3">Músicas do Álbum</h3>
                        {{ musicas.management_form }}
                        <div id="musicas-form-container">
                            {% for musica_form in musicas.forms %}
                            <div class="row g-2 align-items-center musica-form mb-2">
                                {{ musica_form.id }}
                                <div class="col">
                                    {{ musica_form.titulo }}
                                </div>
                                <div class="col-sm-3">
                                    {{ musica_form.duracao }}
                                </div>
                                <div class="col-auto">
                                    {% if musica_form.instance.pk and musicas.can_delete %}
                                    <div class="form-check">
                                        {{ musica_form.DELETE }}
                                        <label class="form-check-label" for="{{ musica_form.DELETE.id_for_label }}">Remover</label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="add-musica-btn" class="btn btn-outline-success btn-sm mt-2">Adicionar Música</button>
                        <div id="empty-form-template" style="display: none;">
                            <div class="row g-2 align-items-center musica-form mb-2">
                                <div class="col">
                                    {{ musicas.empty_form.titulo }}
                                </div>
                                <div class="col-sm-3">
                                    {{ musicas.empty_form.duracao }}
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-musica-btn">Remover</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="card-footer text-end">
                        <a href="{% url 'listar-albums' %}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const fotoInput = document.getElementById('{{ form.foto.id_for_label }}');
    const previewFoto = document.getElementById('preview-foto');
    if (fotoInput) {
        fotoInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                previewFoto.src = URL.createObjectURL(file);
            }
        });
    }

    const addMusicaBtn = document.getElementById('add-musica-btn');
    const container = document.getElementById('musicas-form-container');
    const template = document.getElementById('empty-form-template').innerHTML;
    const totalForms = document.getElementById('id_musicas-TOTAL_FORMS');

    addMusicaBtn.addEventListener('click', function() {
        let formIndex = parseInt(totalForms.value);
        const newFormHTML = template.replace(/__prefix__/g, formIndex);
        const newFormNode = document.createElement('div');
        newFormNode.innerHTML = newFormHTML;
        container.append(newFormNode.firstElementChild);
        totalForms.value = formIndex + 1;
    });

    container.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-musica-btn')) {
            e.target.closest('.musica-form').remove();
        }
    });
});
</script>
{% endblock %}